<!DOCTYPE html>
<!--[if lt IE 7]>      <html lang="en" ng-app="myApp" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html lang="en" ng-app="myApp" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html lang="en" ng-app="myApp" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en" ng-app="myApp" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>My AngularJS App</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- <link rel="stylesheet" href="lib/html5-boilerplate/dist/css/normalize.css"> -->
  <!-- <link rel="stylesheet" href="lib/html5-boilerplate/dist/css/main.css"> -->
  <link rel="stylesheet" href="app.css">
  <!-- <script src="lib/html5-boilerplate/dist/js/vendor/modernizr-2.8.3.min.js"></script> -->

  <script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>

  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  <!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-database.js"></script>



<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-analytics.js"></script>

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyCS5kPqj_Ab9VKezoDuUAU-qv9wnvZXQjI",
    authDomain: "events-cs411.firebaseapp.com",
    databaseURL: "https://events-cs411.firebaseio.com",
    projectId: "events-cs411",
    storageBucket: "events-cs411.appspot.com",
    messagingSenderId: "1024521458752",
    appId: "1:1024521458752:web:7f8e348415f3f2a1837ba5",
    measurementId: "G-9HYN13DGEH"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
</script>
</head>
<body background="blue-snow.png"> 
<h1 style="background-color:royalblue"><center>EventLocator</center></h1>

  <!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
  <![endif]-->

  <div ng-view></div>

<!--user input form-->

  <div class="container" id = "login-form" style="padding-bottom: 10px;">>
    <div class="well">
      <h3>Please sign in or create a new account</h3>
  <form>
  <div class="form-group">
    <label for="InputEmail">Email address</label>
    <input type="email" class="form-control" id="InputEmail" placeholder="Email">
  </div>
  <div class="form-group">
    <label for="InputPassword">Password</label>
    <input type="password" class="form-control" id="InputPassword" placeholder="Password">
  </div>

  <button id = "sign-in-button" type="button" class="btn btn-primary btn-block">Sign In</button>
  <button id = "create-newuser-button" type="button" class="btn btn-primary btn-block">Create New Account</button>
  <button id = "google-button" button onclick = "google_login()" type="button" class="btn btn-primary btn-block">Sign In With Google
  <img width="20px" style="margin-bottom:3px; margin-right:5px" alt="Google sign-in" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Google_%22G%22_Logo.svg/512px-Google_%22G%22_Logo.svg.png" /></button>
    <button id = "twitter-button" button onclick = "twitter_login()" type="button" class="btn btn-primary btn-block">Sign In With Twitter
    <img width="20px" style="margin-bottom:3px; margin-right:5px" alt="Twitter sign-in" src="twitter.png" /></button>

  </form>
      </div>
    </div>
<hr>

  <div class="container" id = "logout-form">
      <button id = "logout-button" type="button" class="btn btn-primary btn-block">Logout</button>

  </div>

  <hr>

<!--  show events here-->
 <div class="container" id="show-events">
  <h1 style="color:mediumblue; font-size:36px">Events</h1>
   <h4>TicketMaster</h4>
   <p class="api_data_tm"></p>
   <div id="tm_table"></div>
   <h4>Stubhub</h4>
   <p class="api_data_pd"></p>
   <div id="sh_table"></div>


 </div>
<hr>

<!-- The User's   preference form -->

    <div class="container" id = "Preferences" style="display: none">
    <div class="well">
      <h3>Enter Preferences</h3>
  <form>
  <div class="form-group">
    <label for="InputLocation">Location</label>
    <input type="text" class="form-control" id="InputLocation" placeholder="Location">
    <label for="ResultNumber">How many Events</label>
    <input type="text" class="form-control" id="ResultNumber" placeholder="Results">
  </div>

  <button id = "submit-pref" type="button" class="btn btn-primary btn-block">Submit</button>

  </form>
      </div>
    </div>

<!--  scripts-->
  <script>

    // button listeners
    $("#create-newuser-button").click(function () {
        var email = $("#InputEmail").val();
        var password = $("#InputPassword").val();
        console.log("New User =" + email + " " + password);
        CreateNewUser(email,password )
    });

     $("#sign-in-button").click(function () {
        var email = $("#InputEmail").val();
        var password = $("#InputPassword").val();
        console.log("New User =" + email + " " + password);
        SignIn(email,password )
    });

     $("#logout-button").click(function () {
        firebase.auth().signOut();
        console.log('Signed Out');
        alert("Logged out");
        window.location.reload();
    });

     $("#submit-pref").click(function () {
        var pref = {
          id: currentUser.uid,
          location: $("#InputLocation").val(),
          num_results: $("#ResultNumber").val()
        };
        addPreferences(pref);
        console.log(pref);
        return pref;

    });

    google_login=()=> {
      base_provider = new firebase.auth.GoogleAuthProvider()
      firebase.auth().signInWithPopup(base_provider).then(function(result){
        var x = document.getElementById("Preferences");
        x.style.display = "block";
        alert("Google Account Successfully Linked")
        console.log("Success Google account linked")
        console.log(result)
        removeElement("sign-in-button")
        removeElement("create-newuser-button")
        removeElement("google-button")
        removeElement("twitter-login")
      }).catch(function(err){
        console.log(err)
        console.log("Failed to connect to google aksdakjsd klashdl kjs")
      })
    }
    
twitter_login=()=> {
      base_provider = new firebase.auth.TwitterAuthProvider()
      firebase.auth().signInWithPopup(base_provider).then(function(result){
        var x = document.getElementById("Preferences");
        x.style.display = "block";
        alert("Twitter Account Successfully Linked")
        console.log("Success Twitter account linked")
        console.log(result)
        removeElement("sign-in-button")
        removeElement("create-newuser-button")
        removeElement("google-button")
        removeElement("twitter-button")
      }).catch(function(err){
        console.log(err)
        console.log("Failed to connect to Twitter aksdakjsd klashdl kjs")
      })
    }

     
    function addPreferences(p) {
      //write this data to database
       firebase.database().ref("preferences/" + p.id).set(p);
       firebase.database().ref("users/" + currentUser.uid + "/preferences/" + p.id).set(p);
       getLocation()
       getEvents()

    }

    function CreateNewUser(email, password) {

      firebase.auth().createUserWithEmailAndPassword(email, password).catch(function (result) {
        alert("Account Successfully created")
        console.log("Successfully created")
        console.log(result)
      })
        // Handle Errors here.
        .catch(function (error) {
        var errorCode = error.code;
        var errorMessage = error.message;
        console.log(errorMessage);
        alert(errorMessage);
      })

    }
    
    function removeElement(elementId) {
    // Removes an element 
    var element = document.getElementById(elementId);
    element.parentNode.removeChild(element);
}
    
    function writeUserData(user) {
      firebase.database().ref('users/' + user.uid).set({
        email: user.email
      });
    }

    function SignIn(email, password) {

      firebase.auth().signInWithEmailAndPassword(email, password).then(function(result) {
        var x = document.getElementById("Preferences");
        x.style.display = "block";
        alert("Account Successfully logged in")
        console.log("Successfully created")
        console.log(result)
        removeElement("sign-in-button")
        removeElement("create-newuser-button")
        removeElement("google-button")
      })
        .catch(function (error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        console.log(errorMessage);
        alert(errorMessage);
      });
    }

    function getLocation() {
      var userId = firebase.auth().currentUser.uid;

      var locationRef = firebase.database().ref('users/' + currentUser.uid + '/preferences/' + currentUser.uid + "/location");
      locationRef.once('value', function (snapshot) {
        console.log(snapshot.val());
        location_api = snapshot.val();
        return location_api

      });
    }

    function getEvents() {
      var location = location_api;
      var num_results = $("#ResultNumber").val();
      // console.log("this is #: " + num_results);
      var table = $('<table border="1">');
      table.addClass("bordered");

      var table2= $('<table border="1">');
      table2.addClass("bordered");

      $.getJSON(
              "https://app.ticketmaster.com/discovery/v2/events?city=" +
              location + "&size="+ num_results +
              "&apikey=Q2cS3dXLTrdc1isqYwZIeAB7XlLz7Sso",
              function (data) {
                console.log(data);
                $.each(data._embedded.events,function (index, value) {
                    console.log(index + "::" + value.name + "::" + value.url);
                    // $(".api_data_tm").append('<li> Event Name: ' + value.name + 'Event Url: ' + value.url + '</li>');

                    var row = $("<tr><td>" + value.name + "</td><td style='width: min-content'>" +value.dates.start.localDate + "</td><td>" + value.url + "</td></tr>");

                    table.append(row);
                });
                // $(".api_data_tm").append(JSON.stringify(data));
                $('#tm_table').append(table);
                table.addClass("bordered");


              }
      )

      var settings = {
      "async": true,
      "crossDomain": true,
      "url": "https://api.stubhub.com/sellers/search/events/v3?city=" + location + "&rows=" + num_results,
      "method": "GET",
      "headers": {
        "Authorization": "Bearer xJb9nBz1Skpv21Y7iQfS2G2x3WdM",
        "User-Agent": "PostmanRuntime/7.18.0",
        "Accept": "*/*",
        "Cache-Control": "no-cache",
        "Postman-Token": "dcc5e3ae-baa8-4b2d-b396-75e2d5644f66,020d3ae4-bcc2-44b7-a3f6-96895a9fa49c",
        "Host": "api.stubhub.com",
        "Accept-Encoding": "gzip, deflate",
        "Cookie": "akacd_PR_app_api_stubhub=1575497261~rv=3~id=6401cd4636979d51074f731c519973a5",
        "Connection": "keep-alive",
        "cache-control": "no-cache"
      }
    }

    $.ajax(settings).done(function (response) {
      console.log(response);
      $.each(response.events,function (index, value) {
            console.log(index + "::" + value.name + "::" + value.url);
            // $(".api_data_pd").append('<li> Event Name: ' + value.name + 'Event Date: ' + value.eventDateLocal + '</li>');
            var row = $("<tr><td>" + value.name + "</td><td>" +value.eventDateLocal + "</td><td>" + "stubhub.com/" + value.webURI + "</td></tr>");

          table2.append(row);
                })
      // $(".api_data_pd").append(JSON.stringify(response));
    });
      $('#sh_table').append(table2);
      table2.addClass("bordered");

    }





    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
        var email = user.email;
        currentUser = user;
        writeUserData(user);
        console.log(currentUser.email + " has logged in");
        // User is signed out.
        // ...
      }
    });
  </script>





<!--  template-->

    <div style = "color:crimson"><b>Group 3</b><span app-version></span></div>

  <!-- In production use:
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/x.x.x/angular.min.js"></script>
  -->
  <!-- <script src="lib/angular/angular.js"></script>
  <script src="lib/angular-route/angular-route.js"></script>
  <script src="app.js"></script>
  <script src="view1/view1.js"></script>
  <script src="view2/view2.js"></script>
  <script src="core/version/version.js"></script>
  <script src="core/version/version-directive.js"></script>
  <script src="core/version/interpolate-filter.js"></script> -->

</body>
</html>
